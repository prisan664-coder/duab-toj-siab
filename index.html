<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hukhujai App - Dashboard Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card .card-body {
            padding: 1rem;
        }

        .reaction-btn {
            min-width: 110px;
        }

        .post-meta a {
            text-decoration: none;
        }

        .media-top {
            max-height: 420px;
            object-fit: cover;
        }

        .video-wrap {
            margin-bottom: .75rem;
        }

        .comment-actions button {
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .comment-reply {
            margin-left: 2rem;
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">üíô Hukhujai App</a>
            <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span
                    class="navbar-toggler-icon"></span></button>
            <div id="navbarNav" class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
                     <li class="nav-item"><a class="nav-link" href="support.html">Support</a></li>
                </ul>
                <form class="d-flex" role="search">
                    <input id="searchInput" class="form-control me-2" type="search"
                        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...">
                </form>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="bg-white py-4 shadow-sm text-center">
        <h1 class="fw-bold text-primary">Hukhujai Community üí¨ (Pro)</h1>
        <p class="text-muted">‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô</p>
    </header>

    <main class="container mt-4 mb-5">
        <h4 class="fw-bold mb-3 text-primary">üì∞ Latest Posts</h4>
        <div id="postList" class="row gy-4"></div>
    </main>

    <!-- Comments Modal -->
    <div class="modal fade" id="commentsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Comments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="commentsModalBody"></div>
                <div class="modal-footer">
                    <input type="text" class="form-control" id="modalCommentInput" placeholder="Write a comment">
                    <button class="btn btn-success" id="modalCommentSubmit">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getDatabase, ref, onChildAdded, onChildChanged, onChildRemoved, onValue, set, push, remove, get, update } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDCE_qqKanTTdVXYwBMBIfPu0M0Xy-kbX8",
            authDomain: "hujai-web.firebaseapp.com",
            databaseURL: "https://hujai-web-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "hujai-web",
            storageBucket: "hujai-web.firebasestorage.app",
            messagingSenderId: "827968973337",
            appId: "1:827968973337:web:ae6ef630b59cf429575888",
            measurementId: "G-XCF3TBNG8L"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const postList = document.getElementById("postList");
        const logoutBtn = document.getElementById("logoutBtn");
        const searchInput = document.getElementById("searchInput");
        const commentsModalBody = document.getElementById("commentsModalBody");
        const modalCommentInput = document.getElementById("modalCommentInput");
        const modalCommentSubmit = document.getElementById("modalCommentSubmit");

        let currentUser = null;
        let usersCache = {};
        let postsIndex = {};
        let allPostsList = [];
        let currentModalPostId = null;
        let bsCommentsModal = null;

        // Utility functions
        function escapeHtml(s) { return s ? String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;') : ""; }
        function buildMediaHTML(post) { let media = ""; if (post.imageURL) { media += `<img src="${escapeHtml(post.imageURL)}" class="card-img-top media-top">`; } if (post.videoURL) { media += `<div class="ratio ratio-16x9 video-wrap"><iframe src="${escapeHtml(post.videoURL)}" allowfullscreen></iframe></div>`; } return media; }
        function timeAgo(dateStr) { const now = new Date(); const past = new Date(dateStr); const diffMs = now - past; const diffMins = Math.floor(diffMs / 60000); if (diffMins < 1) return "‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤"; if (diffMins < 60) return `${diffMins} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤`; const diffHours = Math.floor(diffMins / 60); if (diffHours < 24) return `${diffHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤`; const diffDays = Math.floor(diffHours / 24); return `${diffDays} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤`; }

        // Load users
        onValue(ref(db, "users/"), snap => { usersCache = snap.val() || {}; });

        // Auth state
        onAuthStateChanged(auth, user => {
            if (!user) { window.location.href = "login.html"; return; }
            currentUser = user;
            update(ref(db, `users/${currentUser.uid}`), { lastLogin: new Date().toISOString() });
        });

        // Posts
        const postsRef = ref(db, "posts/");
        onChildAdded(postsRef, snap => {
            const postId = snap.key; const post = snap.val();
            const el = createPostCard(postId, post);
            postList.prepend(el);
            allPostsList.unshift([postId, post]);
            setupCountsWatcher(postId);
            setupCommentsPreview(postId);
        });
        onChildChanged(postsRef, snap => {
            const postId = snap.key; const post = snap.val();
            const wrapper = postsIndex[postId]; if (!wrapper) return;
            wrapper.querySelector(".card-title").textContent = post.title || "";
            wrapper.querySelector(".card-text").textContent = post.content || "";
        });
        onChildRemoved(postsRef, snap => {
            const postId = snap.key;
            const wrapper = postsIndex[postId]; if (wrapper) wrapper.remove();
            delete postsIndex[postId];
        });

        // Create Post Card
        function createPostCard(postId, post) {
            const el = document.createElement("div");
            el.className = "col-12";
            el.innerHTML = `<div class="card shadow-sm" data-post-id="${postId}">
    ${buildMediaHTML(post)}
    <div class="card-body">
    <h5 class="card-title">${escapeHtml(post.title || "")}</h5>
    <p class="card-text">${escapeHtml(post.content || "")}</p>
    <div class="d-flex align-items-center mb-2 post-meta">
    <img src="${escapeHtml(usersCache[post.userId]?.photoURL || 'https://via.placeholder.com/30')}" class="rounded-circle me-2" width="30" height="30">
    <span class="text-muted small">Posted by <a href="#" class="fw-bold text-decoration-none text-primary">${escapeHtml(usersCache[post.userId]?.name || "Anonymous")}</a> on ${post.date || ""}</span>
    </div>
    <div class="d-flex mb-2 align-items-center">
    <button class="btn btn-sm btn-outline-primary me-2 reaction-btn js-like-btn">üëç Like (<span class="js-like-count">0</span>)</button>
    <button class="btn btn-sm btn-outline-secondary me-2 js-comment-btn">üí¨ Comment (<span class="js-comments-count">0</span>)</button>
    </div>
    <div id="comments-${postId}" class="mb-2"></div>
    </div></div>`;

            el.querySelector(".js-like-btn").addEventListener("click", async () => { await toggleReaction(postId); trackUserInteraction("likes", postId); });
            el.querySelector(".js-comment-btn").addEventListener("click", () => openCommentsModal(postId));
            postsIndex[postId] = el;
            return el;
        }

        // Counts watcher
        function setupCountsWatcher(postId) {
            const rRef = ref(db, `posts/${postId}/reactions`);
            onValue(rRef, snap => {
                const likes = snap.exists() ? Object.keys(snap.val()).length : 0;
                updateCounts(postId, { likes });
            });
        }
        function updateCounts(postId, counts) {
            const wrapper = postsIndex[postId]; if (!wrapper) return;
            wrapper.querySelector(".js-like-count").textContent = counts.likes ?? "0";
        }

        // Comments Modal
        function setupCommentsPreview(postId) {
            const commentsRef = ref(db, `posts/${postId}/comments`);
            onValue(commentsRef, snap => {
                const data = snap.val() || {};
                const commentsDiv = document.getElementById(`comments-${postId}`);
                commentsDiv.innerHTML = "";
                Object.entries(data).filter(([cid, c]) => !c.parentId).slice(0, 3).forEach(([cid, c]) => {
                    const user = usersCache[c.userId] || {};
                    const name = user.name || "Anonymous";
                    const div = document.createElement("div");
                    div.className = "d-flex align-items-start mb-1";
                    div.innerHTML = `<strong>${escapeHtml(name)}</strong>: ${escapeHtml(c.text)} <small class="text-muted ms-2">${timeAgo(c.date)}</small>`;
                    commentsDiv.appendChild(div);
                });
            });
        }

        function openCommentsModal(postId) {
            currentModalPostId = postId;
            commentsModalBody.innerHTML = "";
            const commentsRef = ref(db, `posts/${postId}/comments`);
            onValue(commentsRef, snap => {
                const data = snap.val() || {};
                commentsModalBody.innerHTML = "";
                const commentsMap = {};
                Object.entries(data).forEach(([cid, c]) => { commentsMap[cid] = { ...c, id: cid, children: [] }; });
                Object.values(commentsMap).forEach(c => { if (c.parentId) commentsMap[c.parentId]?.children.push(c); });
                Object.values(commentsMap).filter(c => !c.parentId).forEach(c => renderComment(c, commentsModalBody));
            });
            function renderComment(c, container) {
                const user = usersCache[c.userId] || {};
                const photoURL = user.photoURL || "https://via.placeholder.com/30";
                const name = user.name || "Anonymous";
                const commentDiv = document.createElement("div");
                commentDiv.className = "mb-2";
                commentDiv.innerHTML = `<div class="d-flex align-items-start">
        <img src="${photoURL}" class="rounded-circle me-2" width="30" height="30">
        <div style="flex:1">
        <strong>${escapeHtml(name)}</strong><br>
        <span class="js-comment-text">${escapeHtml(c.text)}</span><br>
        <small class="text-muted">${timeAgo(c.date)}</small>
        <div class="comment-actions"></div>
        <div class="replies ms-4 mt-1"></div>
        </div></div>`;
                const actionsDiv = commentDiv.querySelector(".comment-actions");
                const repliesContainer = commentDiv.querySelector(".replies");
                if (c.userId === currentUser.uid) {
                    const editBtn = document.createElement("button"); editBtn.className = "btn btn-sm btn-outline-primary"; editBtn.textContent = "Edit";
                    editBtn.onclick = () => { const t = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå:", c.text); if (t) update(ref(db, `posts/${postId}/comments/${c.id}`), { text: t }); };
                    const deleteBtn = document.createElement("button"); deleteBtn.className = "btn btn-sm btn-outline-danger"; deleteBtn.textContent = "Delete";
                    deleteBtn.onclick = () => { if (confirm("‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ?")) remove(ref(db, `posts/${postId}/comments/${c.id}`)); };
                    actionsDiv.appendChild(editBtn); actionsDiv.appendChild(deleteBtn);
                }
                const replyBtn = document.createElement("button"); replyBtn.className = "btn btn-sm btn-outline-secondary"; replyBtn.textContent = "Reply";
                replyBtn.onclick = async () => {
                    const replyText = prompt("‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ:");
                    if (replyText) {
                        const newRef = push(ref(db, `posts/${postId}/comments`));
                        await set(newRef, { userId: currentUser.uid, text: replyText, date: new Date().toISOString(), parentId: c.id });
                        trackUserInteraction("comments", postId);
                    }
                };
                actionsDiv.appendChild(replyBtn);
                c.children.forEach(child => renderComment(child, repliesContainer));
                container.appendChild(commentDiv);
            }
            modalCommentSubmit.onclick = async () => {
                const text = modalCommentInput.value.trim(); if (!text) return;
                const newRef = push(ref(db, `posts/${postId}/comments`));
                await set(newRef, { userId: currentUser.uid, text, date: new Date().toISOString(), parentId: null });
                trackUserInteraction("comments", postId);
                modalCommentInput.value = "";
            };
            new bootstrap.Modal(document.getElementById("commentsModal")).show();
        }

        // Reactions
        async function toggleReaction(postId) {
            if (!currentUser) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
            const rRef = ref(db, `posts/${postId}/reactions/${currentUser.uid}`);
            const snap = await get(rRef);
            if (snap.exists()) await remove(rRef); else await set(rRef, true);
        }

        // Track interactions & send notification
        async function trackUserInteraction(type, postIdOrKeyword) {
            if (!currentUser) return;
            const ts = new Date().toISOString();
            const userRef = ref(db, `userInteractions/${currentUser.uid}/${type}/${postIdOrKeyword}`);
            await set(userRef, { date: ts });

            // Send notification for likes/comments to post owner
            if (type === "likes" || type === "comments") {
                const postSnap = await get(ref(db, `posts/${postIdOrKeyword}`));
                if (postSnap.exists()) {
                    const ownerId = postSnap.val().userId;
                    if (ownerId !== currentUser.uid) {
                        const notifRef = push(ref(db, `notifications/${ownerId}`));
                        await set(notifRef, {
                            postId: postIdOrKeyword,
                            message: `${usersCache[currentUser.uid]?.name || "Someone"} ${type === "likes" ? "liked" : "commented"} your post`,
                            date: ts,
                            read: false
                        });
                    }
                }
            }
        }

        // Search
        searchInput.addEventListener("input", () => { const q = searchInput.value.trim().toLowerCase(); if (q) trackUserInteraction("searches", q); });

        // Logout
        logoutBtn.addEventListener("click", () => { if (!currentUser) return; update(ref(db, `users/${currentUser.uid}`), { lastLogout: new Date().toISOString() }); signOut(auth).then(() => window.location.href = "login.html"); });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>