<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hukhujai Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <!-- üîπ Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger shadow">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">üõ† Hukhujai Admin</a>
            <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div id="navbarNav" class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
                    <li class="nav-item"><a class="nav-link" href="Admin2.html">üí¨ ‡∏î‡∏π‡πÅ‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a></li>
                    <li class="nav-item"><a class="nav-link text-warning" href="#" id="logoutBtn">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- üîπ Header -->
    <header class="bg-white py-4 shadow-sm mb-4">
        <div class="container text-center">
            <h1 class="fw-bold text-danger">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Hukhujai App</h1>
            <p class="text-muted">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
        </div>
    </header>

    <!-- üîπ Manage Members -->
    <main class="container mb-5">
        <h4 class="fw-bold text-primary mb-3">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h4>
        <table class="table table-striped table-hover shadow-sm bg-white">
            <thead class="table-primary">
                <tr>
                    <th>#</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                    <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                    <th>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
                    <th>IP Address</th>
                    <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="userTable"></tbody>
        </table>

        <!-- üîπ Manage Posts -->
        <h4 class="fw-bold text-success mt-5 mb-3">üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå</h4>
        <div class="card shadow mb-3">
            <div class="card-body">
                <input type="text" id="postTitle" class="form-control mb-2" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå">
                <textarea id="postContent" class="form-control mb-2" rows="3" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå"></textarea>
                <input type="url" id="postImage" class="form-control mb-2" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (https://...)">
                <button class="btn btn-success" id="addPostBtn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
            </div>
        </div>
        <div id="postList" class="mb-5"></div>
    </main>

    <!-- Modal ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="reportContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <!-- üîπ Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, remove, update, get } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDCE_qqKanTTdVXYwBMBIfPu0M0Xy-kbX8",
            authDomain: "hujai-web.firebaseapp.com",
            databaseURL: "https://hujai-web-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "hujai-web",
            storageBucket: "hujai-web.firebasestorage.app",
            messagingSenderId: "827968973337",
            appId: "1:827968973337:web:ae6ef630b59cf429575888",
            measurementId: "G-XCF3TBNG8L"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const ADMIN_EMAIL = "admin@hukhujai.com";

        const userTable = document.getElementById("userTable");
        const postList = document.getElementById("postList");
        const addPostBtn = document.getElementById("addPostBtn");
        const postTitle = document.getElementById("postTitle");
        const postContent = document.getElementById("postContent");
        const postImage = document.getElementById("postImage");

        let userData = {};

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤
        onAuthStateChanged(auth, (user) => {
            if (!user) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô!"); window.location.href = "admin-login.html"; return; }
            if (user.email !== ADMIN_EMAIL) { alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‚ùå"); window.location.href = "index.html"; return; }

            // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
            const usersRef = ref(db, "users/");
            onValue(usersRef, async (snapshot) => {
                userTable.innerHTML = "";
                const data = snapshot.val();
                if (data) {
                    userData = data;
                    let index = 1;
                    for (const [uid, info] of Object.entries(data)) {
                        const password = info.password || "-";
                        const createdAt = info.createdAt || "-";
                        const ipAddress = info.ip || "-";

                        userTable.innerHTML += `
                        <tr>
                            <td>${index++}</td>
                            <td>${info.name || "-"}</td>
                            <td>${info.email}</td>
                            <td>${password}</td>
                            <td>${createdAt}</td>
                            <td>${ipAddress}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editUser('${uid}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser('${uid}')">‡∏•‡∏ö</button>
                                <button class="btn btn-sm btn-info" onclick="sendPassword('${uid}')">‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™</button>
                            </td>
                        </tr>`;
                    }
                } else {
                    userTable.innerHTML = `<tr><td colspan="7" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</td></tr>`;
                }
            });

            // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå
            const postsRef = ref(db, "posts/");
            onValue(postsRef, snapshot => {
                postList.innerHTML = "";
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).reverse().forEach(([id, post]) => {
                        const reportCount = post.reports ? Object.keys(post.reports).length : 0;
                        postList.innerHTML += `
                        <div class="card shadow mb-3">
                            <div class="card-body">
                                <input type="text" value="${post.title}" class="form-control mb-2" id="title-${id}">
                                <textarea class="form-control mb-2" rows="2" id="content-${id}">${post.content}</textarea>
                                <input type="url" class="form-control mb-2" value="${post.imageURL}" id="image-${id}">
                                <div class="d-flex justify-content-between mb-2">
                                    <div>
                                        <button class="btn btn-warning btn-sm" onclick="updatePost('${id}')">üíæ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                        <button class="btn btn-danger btn-sm" onclick="deletePost('${id}')">üóë ‡∏•‡∏ö</button>
                                    </div>
                                    <div>
                                        <span class="badge bg-danger">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${reportCount}</span>
                                        <button class="btn btn-sm btn-info" onclick="viewReports('${id}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                } else {
                    postList.innerHTML = `<p class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</p>`;
                }
            });
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
        window.editUser = async (uid) => {
            const userRef = ref(db, "users/" + uid);
            const snapshot = await get(userRef);
            if (!snapshot.exists()) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å");
            const data = snapshot.val();

            const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:", data.name || "");
            if (name === null) return;
            const email = prompt("‡∏≠‡∏µ‡πÄ‡∏°‡∏•:", data.email || "");
            if (email === null) return;
            const password = prompt("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:", data.password || "");
            if (password === null) return;

            update(userRef, { name, email, password }).then(() => alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"));
        }

        window.deleteUser = async (uid) => {
            if (confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?")) {
                await remove(ref(db, "users/" + uid));
                alert("‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
            }
        }

        window.sendPassword = async (uid) => {
            const userRef = ref(db, "users/" + uid);
            const snapshot = await get(userRef);
            if (!snapshot.exists()) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å");
            const password = snapshot.val().password || "-";
            alert(`‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${password}`);
        }

        addPostBtn.addEventListener("click", () => {
            const title = postTitle.value.trim();
            const content = postContent.value.trim();
            const imageURL = postImage.value.trim();
            if (!title || !content || !imageURL) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á!");
            const newPost = push(ref(db, "posts/"));
            set(newPost, { title, content, imageURL, date: new Date().toLocaleString() })
                .then(() => { postTitle.value = ""; postContent.value = ""; postImage.value = ""; alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"); });
        });

        window.updatePost = (id) => {
            const title = document.getElementById(`title-${id}`).value.trim();
            const content = document.getElementById(`content-${id}`).value.trim();
            const imageURL = document.getElementById(`image-${id}`).value.trim();
            if (!title || !content || !imageURL) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á!");
            update(ref(db, "posts/" + id), { title, content, imageURL })
                .then(() => alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"));
        }

        window.deletePost = (id) => {
            if (confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ?")) remove(ref(db, "posts/" + id)).then(() => alert("‚úÖ ‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"));
        }

        window.viewReports = async (postId) => {
            const reportRef = ref(db, `posts/${postId}/reports`);
            const snapshot = await get(reportRef);
            const modalBody = document.getElementById("reportContent");
            modalBody.innerHTML = "";

            if (!snapshot.exists()) {
                modalBody.innerHTML = `<p class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ</p>`;
            } else {
                const reports = snapshot.val();
                const list = Object.entries(reports).map(([id, r], index) => {
                    const userName = userData[r.userId]?.name || r.userId;
                    return `<div class="mb-2"><strong>${index + 1}. ${userName}</strong> (${r.date}):<br>${r.reason}</div>`;
                }).join("");
                modalBody.innerHTML = list;
            }

            const reportModal = new bootstrap.Modal(document.getElementById("reportModal"));
            reportModal.show();
        }

        // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        document.getElementById("logoutBtn").addEventListener("click", () => {
            signOut(auth).then(() => window.location.href = "admin-login.html");
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>